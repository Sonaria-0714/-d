<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>SONALIA: COSMIC FLOW FINAL</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; user-select: none; }
        canvas { display: block; cursor: grab; }

        /* UI LAYER */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        #hud-title {
            position: absolute; top: 40px; left: 40px;
            border-left: 4px solid #00ffff; padding-left: 20px;
            background: linear-gradient(90deg, rgba(0,20,30,0.9), transparent);
        }
        h1 { margin: 0; font-size: 32px; color: #fff; text-shadow: 0 0 20px #00ffff; letter-spacing: 4px; }
        p { margin: 5px 0 0; color: #00ffff; font-size: 14px; letter-spacing: 2px; }

        /* C:F METER */
        #cf-container {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            width: 500px; text-align: center; pointer-events: auto;
        }
        .cf-bar-bg {
            width: 100%; height: 8px; background: #222; border: 1px solid #555; border-radius: 4px;
            position: relative; margin-top: 10px; box-shadow: 0 0 15px rgba(0,255,255,0.1); cursor: pointer;
        }
        .cf-fill {
            position: absolute; top: 0; left: 0; height: 100%; width: 50%;
            background: linear-gradient(90deg, #00ffff, #ff0055); opacity: 0.6;
        }
        .cf-knob {
            width: 16px; height: 24px; background: #fff; position: absolute; top: -8px; left: 50%;
            transform: translateX(-50%); box-shadow: 0 0 10px #fff; transition: left 0.1s; border-radius: 4px;
        }
        .cf-labels { display: flex; justify-content: space-between; font-size: 12px; color: #88aaff; font-weight: bold; }

        /* PANEL */
        #panel {
            position: absolute; top: 0; right: 0; width: 380px; height: 100%;
            background: rgba(8, 12, 16, 0.96); border-left: 1px solid #333;
            transform: translateX(100%); transition: 0.3s; color: #eee; display: flex; flex-direction: column; z-index: 20; pointer-events: auto;
            backdrop-filter: blur(10px);
        }
        #panel.active { transform: translateX(0); }
        .p-head { padding: 40px 30px; border-bottom: 1px solid #333; background: linear-gradient(180deg, rgba(0,255,255,0.1), transparent); }
        .p-tag { font-size: 10px; padding: 4px 10px; border-radius: 2px; background: #00ffff; color: #000; font-weight: 800; }
        .p-title { font-size: 28px; margin: 15px 0 0; color: #fff; text-shadow: 0 0 15px currentColor; }
        .p-body { padding: 30px; overflow-y: auto; flex: 1; }
        .label { font-size: 11px; color: #00ffff; border-bottom: 1px solid rgba(255,255,255,0.2); display: block; margin-bottom: 8px; }
        .text { font-size: 14px; line-height: 1.7; color: #ccc; margin-bottom: 20px; }
        .close-btn { position: absolute; top: 20px; right: 20px; font-size: 24px; cursor: pointer; color: #777; }
        .close-btn:hover { color: #fff; }

        /* LOADER */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 1s; cursor: pointer;
        }
        .load-text { font-size: 40px; color: #fff; font-weight: bold; letter-spacing: 6px; text-shadow: 0 0 30px #00ffff; }
        .load-sub { color: #00ffff; font-family: monospace; margin-top: 15px; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        
        #error-box { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(50,0,0,0.9); border: 1px solid red; padding: 20px; color: #fff; display: none; z-index: 10000; font-family: monospace; }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r120/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.120.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>

    <div id="error-box"></div>

    <div id="loader" onclick="startApp()">
        <div class="load-text">SONALIA</div>
        <div class="load-sub">LOADING NEURAL SYSTEM...</div>
    </div>

    <div id="ui-layer">
        <div id="hud-title">
            <h1>思考回路マップ</h1>
            <p>COSMIC INPUT/OUTPUT CYCLE</p>
        </div>

        <div id="cf-container">
            <div class="cf-labels"><span>COGNITION (思考)</span><span>FEELING (感情)</span></div>
            <div class="cf-bar-bg" id="cf-track">
                <div class="cf-fill" id="cf-fill"></div>
                <div class="cf-knob" id="cf-knob"></div>
            </div>
        </div>
    </div>

    <div id="panel">
        <div class="close-btn" onclick="closePanel()">×</div>
        <div class="p-head">
            <span class="p-tag" id="p-tag">TAG</span>
            <h2 class="p-title" id="p-title">Title</h2>
        </div>
        <div class="p-body">
            <span class="label">DEFINITION</span><div class="text" id="p-desc">...</div>
            <span class="label">ROLE</span><div class="text" id="p-role">...</div>
            <span class="label">THOUGHT</span><div class="text" id="p-thought" style="font-family:monospace; color:#fff;">...</div>
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        window.onerror = function(msg, url, line) {
            const el = document.getElementById('error-box');
            el.style.display = 'block';
            el.innerHTML = "Error: " + msg + "<br>Line: " + line;
            return false;
        };

        // --- Global Variables ---
        let scene, camera, renderer, controls, mainGroup, glowTex;
        let cfRatio = 0.5;
        const interactables = [];
        const clock = new THREE.Clock();
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        
        // Particles
        const meteors = [];
        const senseParticles = [];
        const outParticles = [];
        // 【修正】letに変更して書き換え可能にする
        let memoryParticles = []; 
        
        let memoryGeo, memoryMat;
        const cfFilterMesh = [];
        const nodeCache = { SENSE:[], INPUT:[], OS:[], DB:[], FACTOR:[], OUTPUT:[] };

        const NODES = [
            // 0. 5 SENSES
            { id:"EYE", type:"五感", name:"視覚 (Vision)", color:0xAAFFFF, x:-220, y:60, z:-180, size:8, icon:"EYE", desc:"光情報の受信。", role:"Sensor", thought:"(Seeing)" },
            { id:"EAR", type:"五感", name:"聴覚 (Audio)", color:0xAAFFFF, x:-220, y:30, z:-180, size:8, icon:"EAR", desc:"音情報の受信。", role:"Sensor", thought:"(Hearing)" },
            { id:"NOSE", type:"五感", name:"嗅覚 (Smell)", color:0xAAFFFF, x:-220, y:0, z:-180, size:8, icon:"NOSE", desc:"化学情報の受信。", role:"Sensor", thought:"(Smelling)" },
            { id:"MOUTH", type:"五感", name:"味覚 (Taste)", color:0xAAFFFF, x:-220, y:-30, z:-180, size:8, icon:"LIP", desc:"化学情報の受信。", role:"Sensor", thought:"(Tasting)" },
            { id:"SKIN", type:"五感", name:"触覚 (Touch)", color:0xAAFFFF, x:-220, y:-60, z:-180, size:8, icon:"HAND", desc:"物理刺激の受信。", role:"Sensor", thought:"(Feeling)" },

            // 1. INPUT
            { id:"IN", type:"INPUT", name:"入力統合", color:0xFFFFFF, x:0, y:0, z:-180, size:10, desc:"情報の統合。", role:"Hub", thought:"..." },
            // 2. OS
            { id:"OS4", type:"OS", name:"時間/協調", color:0xFFD700, x:0, y:0, z:-110, size:6, desc:"大局観。", role:"Meta", thought:"..." },
            { id:"OS3", type:"OS", name:"報酬/意味", color:0xAA00FF, x:0, y:0, z:-90, size:6, desc:"価値判断。", role:"Value", thought:"..." },
            { id:"OS2", type:"OS", name:"評価/所属", color:0x3388FF, x:0, y:0, z:-70, size:6, desc:"社会性。", role:"Social", thought:"..." },
            { id:"OS1", type:"OS", name:"生存/生活", color:0x00FFFF, x:0, y:0, z:-50, size:6, desc:"生存本能。", role:"Survival", thought:"..." },
            // 3. DB
            { id:"DB1", type:"DB", name:"欲求DB", color:0xFF5500, x:-30, y:-10, z:10, size:10, desc:"渇望。", role:"Drive", thought:"..." },
            { id:"DB2", type:"DB", name:"情動DB", color:0x0044FF, x:30, y:-10, z:10, size:10, desc:"感情。", role:"Emotion", thought:"..." },
            { id:"DB3", type:"DB", name:"価値観DB", color:0xFFCC00, x:30, y:-10, z:-30, size:10, desc:"信念。", role:"Belief", thought:"..." },
            { id:"DB4", type:"DB", name:"無意識DB", color:0x888888, x:-30, y:-10, z:-30, size:10, desc:"反射。", role:"Reflex", thought:"..." },
            // 4. FACTOR
            { id:"IQ", type:"係数", name:"IQ", color:0x00CCFF, z:70, angle:0, size:7, desc:"論理。", role:"Logic", thought:"..." },
            { id:"EQ", type:"係数", name:"EQ", color:0xFF6666, z:70, angle:1, size:7, desc:"感情。", role:"Empathy", thought:"..." },
            { id:"SQ", type:"係数", name:"SQ", color:0xFFCC00, z:70, angle:2, size:7, desc:"社会。", role:"Social", thought:"..." },
            { id:"AQ", type:"係数", name:"AQ", color:0x888888, z:70, angle:3, size:7, desc:"逆境。", role:"Resilience", thought:"..." },
            { id:"CQ", type:"係数", name:"CQ",
